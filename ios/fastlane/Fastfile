# Working flatlane file on route:  # This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:ios)

platform :ios do

before_all do
    ENV["MATCH_PASSWORD"] = "0728306459"
    ENV["SLACK_URL"] = "https://hooks.slack.com/services/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"
end

desc "Build ipa"
  lane :build_ipa do
       xcversion(version: "13.0")
       xcode_select("/Applications/Xcode_13.0.app")
       ensure_xcode_version(version: "13.0")
       setup_ci
       sync_code_signing(
          type: "appstore",
          readonly: is_ci
        )

       api_key = app_store_connect_api_key(
         key_id: "K73ZGL55QX",
         issuer_id: "059aa589-88cb-48fb-b7c5-4aa58ba52aed",
         key_filepath: "fastlane/testkey.p8",
         duration: 1200,
         in_house: false
        )

         match(
                type: 'appstore',
                api_key: api_key,
                readonly: is_ci
               )

               #### USE THIS ONCE YOU CAN DETERMINE THE TYPE OF RELEASE
#         increment_version_number_in_plist(
#           bump_type: 'patch'
#         )

      version = get_version_number_from_plist(xcodeproj: "Runner.xcodeproj",build_configuration_name: 'Release')
      current_build_number = latest_testflight_build_number(version: version)
      increment_build_number(
        build_number: current_build_number + 1
      )

      testflight_build = current_build_number + 1

      gym(
        scheme: "Runner",
        export_method: "app-store",
        configuration: "Release"
      )

#       pilot(
#         skip_submission: false,
#         distribute_external: false,
#         skip_waiting_for_build_processing: true,
# #         groups: ["First Beta Group"],
#       )

        slack(message: ":airplane: The new build is uploaded to testflight: version #{version} & Build number : #{testflight_build}", success: true, payload: {"Build Date" => Time.new.to_s,
              "Built by" => " iOS CI Server",})

###### Start using this once you activate increment_version_number_in_plist
#         add_git_tag(
#            tag: "#{version}-#{testflight_build}"
#         )
#         git_add(path: "*.plist", shell_escape: false)
#         git_commit(path: "*.plist", message: "version #{version}-#{testflight_build}")
#
#         push_to_git_remote(
#           remote: "origin",
#           local_branch: "ch-fastlane",
#           remote_branch: "ch-fastlane",
#           tags: true
#         )
    end

    after_all do |lane|
    	slack(
    		message: "Commit Successful :rocket:"
    		)
    	end

    	error do |lane, exception|
    		slack(
    			message: exception.message,
    			success:false
    		)
    	end
  end


